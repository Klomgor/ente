name: "Release (ensu)"

on:
    push:
        # Run when a tag matching the pattern "ensu-v*" is pushed
        tags:
            - "ensu-v*"
    # Also allow manually running the workflow
    workflow_dispatch:

env:
    NDK_VERSION: "27.0.12077973"

permissions:
    contents: write

jobs:
    release-desktop:
        environment: "auth-win-build"
        strategy:
            fail-fast: false
            matrix:
                platform:
                    - os: ubuntu-22.04
                      rust-target: x86_64-unknown-linux-gnu
                    - os: macos-latest
                      rust-target: x86_64-apple-darwin
                    - os: macos-latest
                      rust-target: aarch64-apple-darwin
                    - os: windows-latest
                      rust-target: x86_64-pc-windows-msvc

        runs-on: ${{ matrix.platform.os }}
        env:
            HAS_MAC_SIGNING: ${{ secrets.MAC_OS_CERTIFICATE != '' && secrets.MAC_OS_CERTIFICATE_PASSWORD != '' && secrets.APPLE_ID != '' && secrets.APPLE_PASSWORD != '' && secrets.APPLE_TEAM_ID != '' }}
            HAS_WINDOWS_SIGNING: ${{ secrets.AZURE_TENANT_ID != '' && secrets.AZURE_CLIENT_ID != '' && secrets.AZURE_CLIENT_SECRET != '' && secrets.AZURE_ENDPOINT != '' && secrets.AZURE_CODE_SIGNING_NAME != '' && secrets.AZURE_CERT_PROFILE_NAME != '' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "yarn"
                  cache-dependency-path: "web/yarn.lock"

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform.rust-target }}

            - name: Set macOS deployment target
              if: matrix.platform.os == 'macos-latest'
              run: |
                  echo "MACOSX_DEPLOYMENT_TARGET=10.15" >> $GITHUB_ENV
                  echo "CMAKE_OSX_DEPLOYMENT_TARGET=10.15" >> $GITHUB_ENV

            - name: Install dependencies (Ubuntu only)
              if: matrix.platform.os == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.0-dev libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

            - name: Rust cache
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      rust/apps/ensu/src-tauri/target
                  key: ${{ runner.os }}-${{ matrix.platform.rust-target }}-cargo-ensu-release-${{ hashFiles('rust/apps/ensu/src-tauri/Cargo.lock') }}

            - name: Install web dependencies
              working-directory: web
              run: yarn install --frozen-lockfile

            - name: Build WASM
              working-directory: web
              run: yarn build:wasm

            - name: Install Tauri dependencies
              working-directory: rust/apps/ensu
              run: yarn install

            - name: Fetch Rust dependencies
              shell: bash
              working-directory: rust/apps/ensu/src-tauri
              run: cargo fetch

            - name: Patch llama.cpp mtmd sources
              shell: bash
              run: rust/ensu/inference/tool/patch_llama_mtmd.sh

            - name: Build and release Tauri app
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
                  MACOSX_DEPLOYMENT_TARGET: ${{ matrix.platform.os == 'macos-latest' && '10.15' || '' }}
                  CMAKE_OSX_DEPLOYMENT_TARGET: ${{ matrix.platform.os == 'macos-latest' && '10.15' || '' }}
              with:
                  projectPath: rust/apps/ensu
                  tagName: ${{ github.ref_name }}
                  releaseName: "Ensu Desktop ${{ github.ref_name }}"
                  releaseBody: |
                      Desktop release for Ensu

                      **Platforms:**
                      - Linux (AppImage, deb)
                      - macOS (dmg, app)
                      - Windows (msi, exe)

                      Download the appropriate file for your platform below.
                  releaseDraft: true
                  prerelease: false
                  args: ${{ matrix.platform.rust-target != 'x86_64-unknown-linux-gnu' && format('--target {0}', matrix.platform.rust-target) || '' }}

            - name: Install macOS signing dependencies
              if: matrix.platform.os == 'macos-latest' && env.HAS_MAC_SIGNING == 'true'
              run: |
                  pip3 install codemagic-cli-tools --break-system-packages
              shell: bash

            - name: Add macOS signing certificate
              if: matrix.platform.os == 'macos-latest' && env.HAS_MAC_SIGNING == 'true'
              run: |
                  CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
                  echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
                  keychain initialize
                  keychain add-certificates --certificate "$CERTIFICATE_PATH" --certificate-password "$P12_PASSWORD"
              env:
                  BUILD_CERTIFICATE_BASE64: ${{ secrets.MAC_OS_CERTIFICATE }}
                  P12_PASSWORD: ${{ secrets.MAC_OS_CERTIFICATE_PASSWORD }}
              shell: bash

            - name: Locate macOS DMG
              id: macos-dmg
              if: matrix.platform.os == 'macos-latest' && env.HAS_MAC_SIGNING == 'true'
              run: |
                  DMG_PATH=$(find "${{ github.workspace }}/rust/apps/ensu/src-tauri/target/${{ matrix.platform.rust-target }}/release/bundle" -type f -name "*.dmg" | head -n 1)
                  if [ -z "$DMG_PATH" ]; then
                      echo "No DMG artifact found"
                      exit 1
                  fi
                  echo "path=$DMG_PATH" >> "$GITHUB_OUTPUT"
                  echo "Found DMG: $DMG_PATH"
              shell: bash

            - name: Sign macOS DMG
              if: matrix.platform.os == 'macos-latest' && env.HAS_MAC_SIGNING == 'true'
              run: |
                  CERT_NAME=$(security find-identity -v -p codesigning | grep "Developer ID Application" | awk -F'"' '{print $2}' | grep -m1 "")
                  codesign --force --timestamp --sign "$CERT_NAME" --options runtime "${{ steps.macos-dmg.outputs.path }}"
                  codesign --verify --verbose=4 "${{ steps.macos-dmg.outputs.path }}"
              shell: bash

            - name: Notarize and staple DMG
              if: matrix.platform.os == 'macos-latest' && env.HAS_MAC_SIGNING == 'true'
              run: |
                  xcrun notarytool submit "${{ steps.macos-dmg.outputs.path }}" \
                    --wait \
                    --apple-id "$APPLE_ID" \
                    --password "$APPLE_PASSWORD" \
                    --team-id "$APPLE_TEAM_ID"
                  xcrun stapler staple "${{ steps.macos-dmg.outputs.path }}"
              env:
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
              shell: bash

            - name: Upload signed macOS artifacts to draft GitHub release
              if: matrix.platform.os == 'macos-latest' && env.HAS_MAC_SIGNING == 'true'
              uses: ncipollo/release-action@v1
              with:
                  tag: ${{ github.ref_name }}
                  artifacts: ${{ steps.macos-dmg.outputs.path }}
                  draft: true
                  allowUpdates: true
                  updateOnlyUnreleased: true

            - name: Locate Windows signing artifacts
              id: windows-signing-artifacts
              if: matrix.platform.os == 'windows-latest' && env.HAS_WINDOWS_SIGNING == 'true'
              shell: bash
              run: |
                  ARTIFACT_DIR="${{ github.workspace }}/rust/apps/ensu/src-tauri/target/${{ matrix.platform.rust-target }}/release/bundle"
                  mapfile -t SIGN_FILES < <(find "$ARTIFACT_DIR" -type f \( -name "*.exe" -o -name "*.msi" \))

                  if [ "${#SIGN_FILES[@]}" -eq 0 ]; then
                      echo "No Windows executable/MSI artifacts found for signing"
                      exit 1
                  fi

                  {
                    echo "files<<EOF"
                    for file in "${SIGN_FILES[@]}"; do
                      echo "$file"
                    done
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Sign files with Trusted Signing
              if: matrix.platform.os == 'windows-latest' && env.HAS_WINDOWS_SIGNING == 'true'
              uses: azure/trusted-signing-action@v0
              with:
                azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
                azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
                endpoint: ${{ secrets.AZURE_ENDPOINT }}
                trusted-signing-account-name: ${{ secrets.AZURE_CODE_SIGNING_NAME }}
                certificate-profile-name: ${{ secrets.AZURE_CERT_PROFILE_NAME }}
                files: ${{ steps.windows-signing-artifacts.outputs.files }}
                file-digest: SHA256
                timestamp-rfc3161: http://timestamp.acs.microsoft.com
                timestamp-digest: SHA256

            - name: Upload signed Windows artifacts to draft GitHub release
              if: matrix.platform.os == 'windows-latest' && env.HAS_WINDOWS_SIGNING == 'true'
              uses: ncipollo/release-action@v1
              with:
                  tag: ${{ github.ref_name }}
                  artifacts: ${{ steps.windows-signing-artifacts.outputs.files }}
                  allowUpdates: true
                  draft: true
                  updateOnlyUnreleased: true

    build-android:
        runs-on: ubuntu-latest
        needs: release-desktop
        env:
            HAS_ANDROID_SIGNING: ${{ secrets.SIGNING_KEY_ENSU != '' && secrets.SIGNING_STORE_PASSWORD_ENSU != '' && secrets.SIGNING_KEY_ALIAS_ENSU != '' && secrets.SIGNING_KEY_PASSWORD_ENSU != '' }}
            HAS_PLAYSTORE_SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT_JSON_ENSU != '' }}
            HAS_DISCORD_WEBHOOK: ${{ secrets.DISCORD_INTERNAL_RELEASE_WEBHOOK != '' }}

        defaults:
            run:
                working-directory: mobile/native/android/apps/ensu

        steps:
            - name: Checkout code and submodules
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Install NDK
              run: |
                  echo "y" | sdkmanager --install "ndk;${{ env.NDK_VERSION }}"
                  echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

            - name: Install cargo-ndk
              run: cargo install cargo-ndk

            - name: Build Rust libraries
              run: |
                  cd ../../packages/rust/tool
                  ./build_android.sh
              env:
                  ANDROID_HOME: ${{ env.ANDROID_HOME }}
                  NDK_VERSION: ${{ env.NDK_VERSION }}

            - name: Print Android release capabilities
              run: |
                  echo "HAS_ANDROID_SIGNING=${HAS_ANDROID_SIGNING}"
                  echo "HAS_PLAYSTORE_SERVICE_ACCOUNT=${HAS_PLAYSTORE_SERVICE_ACCOUNT}"
                  echo "HAS_DISCORD_WEBHOOK=${HAS_DISCORD_WEBHOOK}"

            - name: Setup signing keys
              if: env.HAS_ANDROID_SIGNING == 'true'
              run: |
                  KEYSTORE_PATH=$(pwd)/ensu-release.keystore
                  echo "${{ secrets.SIGNING_KEY_ENSU }}" | base64 -d > "$KEYSTORE_PATH"
                  cat > key.properties << EOF
                  storeFile=$KEYSTORE_PATH
                  storePassword=${{ secrets.SIGNING_STORE_PASSWORD_ENSU }}
                  keyAlias=${{ secrets.SIGNING_KEY_ALIAS_ENSU }}
                  keyPassword=${{ secrets.SIGNING_KEY_PASSWORD_ENSU }}
                  EOF

            - name: Build signed Android artifacts
              if: env.HAS_ANDROID_SIGNING == 'true'
              run: |
                  if [ "${HAS_PLAYSTORE_SERVICE_ACCOUNT}" = "true" ]; then
                      ./gradlew :app-ui:assembleRelease :app-ui:bundleRelease
                  else
                      ./gradlew :app-ui:assembleRelease
                  fi

            - name: Collect Android artifacts (signed)
              if: env.HAS_ANDROID_SIGNING == 'true'
              run: |
                  mkdir -p artifacts
                  cp app-ui/build/outputs/apk/release/app-ui-release.apk artifacts/ensu-${{ github.ref_name }}.apk
                  if [ "${HAS_PLAYSTORE_SERVICE_ACCOUNT}" = "true" ]; then
                      cp app-ui/build/outputs/bundle/release/app-ui-release.aab artifacts/ensu-${{ github.ref_name }}.aab
                  fi

            - name: Attach Android artifacts to draft GitHub release
              if: startsWith(github.ref, 'refs/tags/ensu-v') && env.HAS_ANDROID_SIGNING == 'true'
              uses: ncipollo/release-action@v1
              with:
                  artifacts: "mobile/native/android/apps/ensu/artifacts/*"
                  draft: true
                  allowUpdates: true
                  updateOnlyUnreleased: true

            - name: Upload Android artifacts
              if: env.HAS_ANDROID_SIGNING == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: ensu-android-artifacts
                  path: mobile/native/android/apps/ensu/artifacts/*

            - name: Upload AAB to PlayStore
              if: env.HAS_ANDROID_SIGNING == 'true' && env.HAS_PLAYSTORE_SERVICE_ACCOUNT == 'true'
              uses: r0adkll/upload-google-play@v1
              with:
                  serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON_ENSU }}
                  packageName: io.ente.ensu
                  releaseFiles: mobile/native/android/apps/ensu/app-ui/build/outputs/bundle/release/app-ui-release.aab
                  track: internal

            - name: Notify Discord
              if: success() && env.HAS_ANDROID_SIGNING == 'true' && env.HAS_PLAYSTORE_SERVICE_ACCOUNT == 'true' && env.HAS_DISCORD_WEBHOOK == 'true'
              uses: sarisia/actions-status-discord@v1
              with:
                  webhook: ${{ secrets.DISCORD_INTERNAL_RELEASE_WEBHOOK }}
                  nodetail: true
                  title: "ðŸ¤– Internal draft release available for Ensu"
                  description: "Draft release uploaded to Play Store internal track"
                  color: 0x4CAF50
